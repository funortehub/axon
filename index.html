
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Axon A.I</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Axon A.I">
    <link rel="apple-touch-icon" href="https://i.imgur.com/ZsfZEh2.png">
    <meta name="theme-color" content="#0d1117">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Todos os estilos CSS anteriores permanecem exatamente iguais */
        :root {
            --bg-color: #0d1117;
            --terminal-bg: #0a0e14;
            --text-color: #c9d1d9;
            --prompt-color: #58a6ff;
            --command-color: #79c0ff;
            --output-color: #c9d1d9;
            --error-color: #ff7b72;
            --success-color: #3fb950;
            --border-color: #30363d;
            --highlight-color: #1f6feb;
            --diagnosis-color: #a371f7;
            --conduct-color: #56d364;
            --altered-color: #ffcc00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Consolas', 'Courier New', monospace;
            touch-action: manipulation;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        .header {
            background-color: var(--bg-color);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .app-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--prompt-color);
        }

        .status-bar {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        .status-off {
            background-color: var(--error-color);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 18px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .logout-button:hover {
            color: var(--error-color);
        }

        .container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            height: calc(100vh - 65px - 40px);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .header-right {
                gap: 15px;
            }
        }

        .terminal {
            background-color: var(--terminal-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .terminal-header {
            padding: 8px 12px;
            background-color: #161b22;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .terminal-title {
            font-size: 14px;
            font-weight: bold;
        }

        .terminal-actions {
            display: flex;
            gap: 8px;
        }

        .terminal-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .close-btn {
            background-color: #ff5f56;
        }

        .minimize-btn {
            background-color: #ffbd2e;
        }

        .maximize-btn {
            background-color: #27c93f;
        }

        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .interactive-terminal {
            flex: 1;
            min-width: 300px;
        }

        .non-interactive-terminal {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .input-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 0;
        }

        .prompt {
            color: var(--prompt-color);
            white-space: nowrap;
        }

        .command-input {
            background: transparent;
            border: none;
            color: var(--command-color);
            width: 100%;
            font-size: 16px;
            caret-color: var(--command-color);
            outline: none;
            padding: 2px 0;
        }

        .command-output {
            color: var(--output-color);
            white-space: pre-wrap;
            line-height: 1.5;
            text-align: left;
        }

        .command {
            color: var(--command-color);
            font-weight: bold;
        }

        .error {
            color: var(--error-color);
        }

        .success {
            color: var(--success-color);
        }

        .info {
            color: var(--prompt-color);
        }

        .highlight {
            color: var(--highlight-color);
        }

        .anamnesis-content {
            line-height: 1.8;
            font-size: 15px;
        }

        .section-title {
            font-weight: bold;
            margin-top: 10px;
            color: var(--highlight-color);
        }

        .help-list {
            padding-left: 0;
            margin: 10px 0;
            line-height: 1.8;
            list-style: none;
        }

        .help-item {
            margin-bottom: 5px;
        }
        
        .diagnosis-item {
            color: var(--diagnosis-color);
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative;
        }
        
        .diagnosis-item:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--diagnosis-color);
        }
        
        .conduct-section {
            margin-bottom: 15px;
        }
        
        .conduct-title {
            color: var(--conduct-color);
            font-weight: bold;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(86, 211, 100, 0.3);
            padding-bottom: 3px;
        }
        
        .conduct-item {
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative;
        }
        
        .conduct-item:before {
            content: "-";
            position: absolute;
            left: 0;
        }

        .receituario-item {
            white-space: pre;
            font-family: 'Courier New', monospace;
            color: var(--output-color);
            margin-bottom: 5px;
        }

        .footer {
            background-color: var(--bg-color);
            padding: 10px 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-color);
        }

        .terminal-logo-internal {
            position: absolute;
            top: 15px;
            right: 15px;
            height: calc(105.3px * 1.8 * 0.7 * 1.2);
            width: auto;
            opacity: 0.25;
            z-index: 0;
        }

        /* MODIFICAÇÃO: Texto em caixa alta apenas no monitor */
        .monitor-view {
            text-transform: uppercase;
        }

        .monitor-view .section-title,
        .monitor-view .axon-eye-title,
        .monitor-view .conduct-title {
            text-transform: none;
        }

        /* Estilos para o modal da câmera DENTRO DO TERMINAL */
        .camera-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--terminal-bg);
            z-index: 10;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
        }

        .camera-container {
            display: flex;
            flex-direction: column;
            background-color: var(--terminal-bg);
            border: none;
            border-radius: 0;
            position: relative;
            z-index: 1;
            padding: 0;
            gap: 10px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
        }

        .camera-video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 75%;
            background-color: black;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .camera-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            z-index: 2;
            width: 90%;
        }

        .camera-button {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }

        .camera-button:hover {
            background-color: var(--highlight-color);
            transform: scale(1.05);
        }

        .camera-button.disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .camera-action-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .camera-switch-button, .flashlight-button {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Consolas', 'Courier New', monospace;
            transition: background-color: 0.2s;
        }

        .camera-switch-button:hover, .flashlight-button:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .flashlight-button.active {
            background-color: var(--highlight-color);
            color: var(--bg-color);
        }

        .album-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Consolas', 'Courier New', monospace;
            transition: background-color: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
        }

        .album-button:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .album-count {
            background-color: var(--highlight-color);
            color: var(--bg-color);
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }

        .monitor-toggle-buttons {
            display: flex;
            gap: 5px;
            margin-left: auto;
            margin-right: 10px;
        }

        .monitor-toggle-button {
            background-color: #30363d;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .monitor-toggle-button:hover {
            background-color: #444c56;
        }

        .monitor-toggle-button.active {
            background-color: var(--highlight-color);
            color: var(--bg-color);
            border-color: var(--highlight-color);
        }

        #monitor-content-wrapper {
            position: relative;
        }

        .monitor-copy-btn {
            position: absolute;
            top: 50px;
            right: 25px;
            background-color: rgba(48, 54, 61, 0.7);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
            z-index: 5;
        }

        .monitor-copy-btn:hover {
            background-color: #444c56;
        }

        @media (max-width: 768px) {
            .monitor-toggle-button span {
                display: none;
            }

            .monitor-toggle-button {
                padding: 5px 8px;
                font-size: 16px;
                width: auto;
                min-width: 35px;
            }

            .status-bar {
                gap: 10px;
            }
            
            .status-bar .status-item span {
                display: none;
            }
            .status-text-api, .status-text-mic, .status-text-cam {
                 display: none;
            }


            .status-item .status-indicator {
                width: 8px;
                height: 8px;
            }
        }

        .fullscreen-modal {
            display: none;
            position: fixed;
            z-index: 110;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }

        .modal-content, #caption {
            animation-name: zoom;
            animation-duration: 0.6s;
        }

        @keyframes zoom {
            from {transform:scale(0)}
            to {transform:scale(1)}
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .output .altered-text {
            color: var(--altered-color);
            font-weight: bold;
            margin-left: 10px;
        }

        .album-modal {
            display: none;
            position: fixed;
            z-index: 99;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .album-modal-content {
            background-color: var(--terminal-bg);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .album-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .album-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--prompt-color);
        }

        .album-modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .album-modal-close:hover,
        .album-modal-close:focus {
            color: white;
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .album-item {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .album-item:hover {
            transform: scale(1.03);
        }

        .album-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .album-delete-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s;
        }

        .album-delete-button:hover {
            background-color: rgba(255, 0, 0, 1);
        }

        .axon-eye-title {
            color: var(--error-color);
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 123, 114, 0.3);
            padding-bottom: 3px;
        }

        .axon-eye-image-preview {
            max-width: 100%;
            height: auto;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        /* NOVOS ESTILOS PARA O SISTEMA DE SAVE/LOAD */
        .patient-list-modal {
            display: none;
            position: fixed;
            z-index: 99;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .patient-list-content {
            background-color: var(--terminal-bg);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .patient-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .patient-list-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--prompt-color);
        }

        .patient-list-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .patient-list-close:hover,
        .patient-list-close:focus {
            color: white;
        }

        .patient-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            max-height: 400px;
        }

        .patient-item {
            padding: 12px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: background-color: 0.2s;
        }

        .patient-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .patient-details-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }

        .patient-details-content {
            background-color: var(--terminal-bg);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .patient-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .patient-details-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--prompt-color);
        }

        .patient-details-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .patient-details-close:hover,
        .patient-details-close:focus {
            color: white;
        }

        .patient-details-body {
            overflow-y: auto;
            padding-right: 5px;
        }

        .patient-details-section {
            margin-bottom: 20px;
        }

        .patient-details-section-title {
            font-weight: bold;
            color: var(--highlight-color);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        .patient-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .patient-image-item {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
        }

        .patient-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* ESTILOS PARA HISTÓRICO DE CONSULTAS */
        .consultation-item {
            background-color: #161b22;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .consultation-header {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .consultation-header:hover {
            background-color: #21262d;
        }
        .consultation-body {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.1);
        }


        /* NOVOS ESTILOS PARA BOTÕES DE AÇÃO NO PACIENTE */
        .patient-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .patient-action-button {
            background-color: #30363d;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex: 1;
        }
        
        .patient-action-button.disabled {
            background-color: #21262d;
            color: #8b949e;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .patient-action-button:not(.disabled):hover {
            background-color: #444c56;
        }

        .patient-action-button.delete:not(.disabled) {
            background-color: rgba(255, 0, 0, 0.2);
            color: var(--error-color);
        }

        .patient-action-button.delete:not(.disabled):hover {
            background-color: rgba(255, 0, 0, 0.3);
        }

        .patient-action-button.pdf:not(.disabled) {
            background-color: rgba(86, 211, 100, 0.2);
            color: var(--success-color);
        }

        .patient-action-button.pdf:not(.disabled):hover {
            background-color: rgba(86, 211, 100, 0.3);
        }
        
        .patient-action-button.details:not(.disabled) {
             background-color: rgba(88, 166, 255, 0.2);
            color: var(--prompt-color);
        }
        
        .patient-action-button.details:not(.disabled):hover {
            background-color: rgba(88, 166, 255, 0.3);
        }


        /* NOVO ESTILO PARA BARRA DE PESQUISA */
        .patient-search-container {
            margin-bottom: 15px;
        }

        .patient-search-input {
            width: 100%;
            padding: 10px;
            background-color: var(--terminal-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        .patient-search-input:focus {
            outline: none;
            border-color: var(--highlight-color);
        }

        /* NOVOS ESTILOS PARA A BARRA DE AÇÕES MOBILE */
        .terminal-footer {
            padding: 8px 15px;
            border-top: 1px solid var(--border-color);
            background-color: #161b22;
        }

        .action-buttons-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        .action-button {
            background-color: var(--border-color);
            color: var(--text-color);
            border: 1px solid #444c56;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
        }

        .action-button:hover, .action-button:focus {
            background-color: var(--highlight-color);
            color: var(--bg-color);
            outline: none;
        }

        .action-button:active {
            transform: scale(0.95);
        }

        .action-button.active {
            background-color: var(--success-color);
            color: var(--bg-color);
            box-shadow: 0 0 8px var(--success-color);
        }

        /* NOVOS ESTILOS PARA O MODAL DE LOGIN (E SAVE) */
        .app-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .app-modal-content {
            background-color: var(--terminal-bg);
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
            text-align: center;
        }

        .app-modal-header {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .app-modal-title {
            color: var(--prompt-color);
            font-size: 20px;
        }

        .app-modal-body p {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .app-modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
        }

        .app-modal-input:focus {
            outline: none;
            border-color: var(--highlight-color);
        }

        .app-modal-button {
            width: 100%;
            padding: 12px;
            background-color: var(--highlight-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .app-modal-button:hover {
            background-color: #1f6feb;
        }
        
        .app-modal-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .app-modal-feedback {
            margin-top: 15px;
            color: var(--error-color);
            min-height: 20px;
        }

        /* Adicionando um botão de fechar genérico */
        .app-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .app-modal-close:hover {
            color: white;
        }

    </style>
</head>
<body>
    <div class="header">
        <div class="app-title">AXON A.I</div>
        <div class="header-right">
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="api-status"></div>
                    <span class="status-text-api">API</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-off" id="mic-status"></div>
                    <span class="status-text-mic">Microfone</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-off" id="camera-status"></div>
                    <span class="status-text-cam">Câmera</span>
                </div>
            </div>
            <button id="logout-btn" title="Sair" class="logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div class="container">
        <div class="terminal interactive-terminal">
            <div class="terminal-header">
                <div class="terminal-title">Terminal Interativo</div>
                <div class="terminal-actions">
                    <div class="terminal-btn close-btn"></div>
                    <div class="terminal-btn minimize-btn"></div>
                    <div class="terminal-btn maximize-btn"></div>
                </div>
            </div>
            <div class="terminal-content" id="interactive-output">
                <img src="axon.png" alt="Axon Logo Terminal" class="terminal-logo-internal">
                <div id="initial-messages" style="position: relative; z-index: 1;">
                    <pre class="info">
 █████╗ ██╗  ██╗ ██████╗ ███╗   ██╗
██╔══██╗╚██╗██╔╝██╔═══██╗████╗  ██║
███████║ ╚███╔╝ ██║   ██║██╔██╗ ██║
██╔══██║ ██╔██╗ ██║   ██║██║╚██╗██║
██║  ██║██╔╝ ██╗╚██████╔╝██║ ╚████║
╚═╝  ╚═╝╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝
                    </pre>
                    <span class="info">Axon - Assistente Médico v1.0</span><br>
                    <span class="info">Aguardando autenticação...</span><br><br>
                </div>
            </div>
            <div class="terminal-footer">
                <div class="action-buttons-container">
                    <button id="btn-exames" class="action-button" title="Analisar Exames (/exames)"><i class="fas fa-file-medical-alt"></i></button>
                    <button id="btn-see" class="action-button" title="Análise Visual Axon Eye (/see)"><i class="fas fa-eye"></i></button>
                    <button id="btn-hd" class="action-button" title="Gerar Hipóteses Diagnósticas (/hd)"><i class="fas fa-lightbulb"></i></button>
                    <button id="btn-cd" class="action-button" title="Gerar Conduta Médica (/cd)"><i class="fas fa-pills"></i></button>
                    <button id="btn-records" class="action-button" title="Prontuários"><i class="fas fa-book-medical"></i></button>
                    <button id="btn-clear" class="action-button" title="Limpar Sessão (/clear)"><i class="fas fa-eraser"></i></button>
                    <button id="btn-mic" class="action-button" title="Ativar/Desativar Microfone"><i class="fas fa-microphone-slash"></i></button>
                </div>
                <div class="input-line">
                    <span class="prompt">></span>
                    <input type="text" class="command-input" id="command-input" autocomplete="off" autofocus>
                </div>
            </div>
        </div>

        <div class="terminal non-interactive-terminal">
            <div class="terminal-header">
                <div class="terminal-title">Monitor</div>
                <div class="monitor-toggle-buttons">
                    <button id="toggle-anamnesis" class="monitor-toggle-button active">
                        <i class="fas fa-notes-medical"></i><span>Anamnese</span>
                    </button>
                    <button id="toggle-exams" class="monitor-toggle-button">
                        <i class="fas fa-file-medical-alt"></i><span>Exames</span>
                    </button>
                    <button id="toggle-axon-eye" class="monitor-toggle-button">
                        <i class="fas fa-eye"></i><span>Axon Eye</span>
                    </button>
                </div>
                <div class="terminal-actions">
                    <div class="terminal-btn close-btn"></div>
                    <div class="terminal-btn minimize-btn"></div>
                    <div class="terminal-btn maximize-btn"></div>
                </div>
            </div>
            <button id="monitor-copy-btn" class="monitor-copy-btn" title="Copiar Conteúdo"><i class="fas fa-copy"></i></button>
            <div class="terminal-content" id="monitor-content-wrapper">
                <div id="anamnesis-preview" class="monitor-view">
                    <div class="info">Aguardando início da anamnese...</div>
                </div>
                <div id="exams-results-preview" class="monitor-view" style="display: none;">
                    <div class="info">Nenhum exame analisado ainda.</div>
                </div>
                <div id="axon-eye-results-preview" class="monitor-view" style="display: none;">
                    <div class="info">Nenhuma análise visual feita ainda.</div>
                </div>

                <div id="camera-modal" class="camera-modal">
                    <div class="camera-container">
                        <div class="terminal-header">
                            <div class="terminal-title" id="camera-modal-title">Câmera de Exames</div>
                            <div class="terminal-actions">
                                <div class="terminal-btn close-btn" id="camera-close-btn"></div>
                            </div>
                        </div>
                        <div class="terminal-content" style="padding: 10px;">
                            <div class="camera-video-wrapper">
                                <video id="camera-video" class="camera-video" autoplay playsinline></video>
                                <div class="camera-action-buttons">
                                    <button id="flashlight-button" class="flashlight-button" style="display:none;"><i class="fas fa-lightbulb"></i> Lanterna</button>
                                    <button id="camera-switch-button" class="camera-switch-button" style="display:none;"><i class="fas fa-sync-alt"></i> Trocar Câmera</button>
                                </div>
                                <button id="album-button" class="album-button" style="display:none;">
                                    <i class="fas fa-images"></i> Álbum <span id="album-count" class="album-count">0</span>
                                </button>
                                <div class="camera-controls">
                                    <button id="capture-button" class="camera-button" title="Capturar Foto"><i class="fas fa-camera"></i></button>
                                    <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
                                    <button id="upload-button" class="camera-button" title="Carregar Arquivo"><i class="fas fa-upload"></i></button>
                                    <button id="send-exams-button" class="camera-button disabled" title="Enviar Exames"><i class="fas fa-paper-plane"></i></button>
                                    <button id="send-axon-eye-button" class="camera-button disabled" title="Analisar com Axon Eye" style="display:none;"><i class="fas fa-eye"></i></button>
                                    <button id="cancel-camera-button" class="camera-button" title="Cancelar"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <canvas id="camera-canvas" style="display:none;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <span>AXON | Sistema médico inteligente desenvolvido por Ian Bastos</span>
    </div>

    <div id="fullscreen-modal" class="fullscreen-modal">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <div id="album-modal" class="album-modal">
        <div class="album-modal-content">
            <div class="album-modal-header">
                <div class="album-modal-title">Álbum de Exames</div>
                <span class="album-modal-close">&times;</span>
            </div>
            <div id="album-grid" class="album-grid">
            </div>
        </div>
    </div>

    <!-- NOVOS MODAIS PARA SAVE/LOAD -->
    <div id="patient-list-modal" class="patient-list-modal">
        <div class="patient-list-content">
            <div class="patient-list-header">
                <div class="patient-list-title">Pacientes Salvos</div>
                <span class="patient-list-close">&times;</span>
            </div>
            <div class="patient-search-container">
                <input type="text" id="patient-search-input" class="patient-search-input" placeholder="Pesquisar paciente...">
            </div>
            <div id="patient-list" class="patient-list">
            </div>
            <div class="patient-list-footer" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <button id="btn-save-from-list" class="app-modal-button" style="width: 100%;">Salvar Consulta Atual</button>
            </div>
        </div>
    </div>

    <div id="patient-details-modal" class="patient-details-modal">
        <div class="patient-details-content">
            <div class="patient-details-header">
                <div class="patient-details-title" id="patient-details-title">Detalhes do Paciente</div>
                <span class="patient-details-close">&times;</span>
            </div>
            <div id="patient-details-body" class="patient-details-body">
            </div>
        </div>
    </div>

    <!-- MODAL DE LOGIN INICIAL -->
    <div id="login-modal" class="app-modal">
        <div class="app-modal-content">
            <div class="app-modal-header">
                <h2 class="app-modal-title">AXON A.I - Login</h2>
            </div>
            <div class="app-modal-body">
                <p>Por favor, faça login para continuar.</p>
                <input type="text" id="login-modal-user" placeholder="Usuário" class="app-modal-input" autocomplete="username">
                <input type="password" id="login-modal-pass" placeholder="Senha" class="app-modal-input" autocomplete="current-password">
                <button id="login-modal-button" class="app-modal-button">Entrar</button>
                <div id="login-modal-feedback" class="app-modal-feedback"></div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA SALVAR PACIENTE -->
    <div id="save-patient-modal" class="app-modal">
        <div class="app-modal-content">
            <span class="app-modal-close">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title">Salvar Paciente</h2>
            </div>
            <div class="app-modal-body">
                <p>Insira os dados do paciente para salvar a sessão atual.</p>
                <input type="text" id="save-patient-name" placeholder="Nome Completo do Paciente" class="app-modal-input">
                <input type="text" id="save-patient-dob" placeholder="Data de Nascimento (DD/MM/AAAA)" class="app-modal-input">
                <button id="save-patient-button" class="app-modal-button">Salvar</button>
                <div id="save-patient-feedback" class="app-modal-feedback"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4bis9CVQkl1eJDfezsvUKTx1X_kFVT4M",
            authDomain: "axon-91d0b.firebaseapp.com",
            projectId: "axon-91d0b",
            storageBucket: "axon-91d0b.firebasestorage.app",
            messagingSenderId: "701115983749",
            appId: "1:701115983749:web:9a57928b678918ffbb86ec"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Elementos DOM
        const commandInput = document.getElementById('command-input');
        const interactiveOutput = document.getElementById('interactive-output');
        const anamnesisPreview = document.getElementById('anamnesis-preview');
        const examsResultsPreview = document.getElementById('exams-results-preview');
        const axonEyeResultsPreview = document.getElementById('axon-eye-results-preview');
        const apiStatus = document.getElementById('api-status');
        const micStatus = document.getElementById('mic-status');
        const cameraStatus = document.getElementById('camera-status');
        const initialMessagesContainer = document.getElementById('initial-messages');
        const monitorCopyBtn = document.getElementById('monitor-copy-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // Camera elements
        const cameraModal = document.getElementById('camera-modal');
        const cameraModalTitle = document.getElementById('camera-modal-title');
        const cameraVideo = document.getElementById('camera-video');
        const cameraCanvas = document.getElementById('camera-canvas');
        const captureButton = document.getElementById('capture-button');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const sendExamsButton = document.getElementById('send-exams-button');
        const sendAxonEyeButton = document.getElementById('send-axon-eye-button');
        const cancelCameraButton = document.getElementById('cancel-camera-button');
        const cameraSwitchButton = document.getElementById('camera-switch-button');
        const flashlightButton = document.getElementById('flashlight-button');
        const cameraCloseBtn = document.getElementById('camera-close-btn');

        // Monitor toggle buttons
        const toggleAnamnesisButton = document.getElementById('toggle-anamnesis');
        const toggleExamsButton = document.getElementById('toggle-exams');
        const toggleAxonEyeButton = document.getElementById('toggle-axon-eye');

        // Fullscreen Modal elements
        const fullscreenModal = document.getElementById('fullscreen-modal');
        const modalImage = document.getElementById('modal-image');
        const modalClose = document.getElementsByClassName('modal-close')[0];

        // Album Modal elements
        const albumButton = document.getElementById('album-button');
        const albumCount = document.getElementById('album-count');
        const albumModal = document.getElementById('album-modal');
        const albumModalClose = document.getElementsByClassName('album-modal-close')[0];
        const albumGrid = document.getElementById('album-grid');

        // Action buttons
        const btnExames = document.getElementById('btn-exames');
        const btnSee = document.getElementById('btn-see');
        const btnHd = document.getElementById('btn-hd');
        const btnCd = document.getElementById('btn-cd');
        const btnMic = document.getElementById('btn-mic');
        const btnRecords = document.getElementById('btn-records');
        const btnClear = document.getElementById('btn-clear');

        // MODAIS
        const patientListModal = document.getElementById('patient-list-modal');
        const patientList = document.getElementById('patient-list');
        const patientListClose = document.getElementsByClassName('patient-list-close')[0];
        const patientDetailsModal = document.getElementById('patient-details-modal');
        const patientDetailsTitle = document.getElementById('patient-details-title');
        const patientDetailsBody = document.getElementById('patient-details-body');
        const patientDetailsClose = document.getElementsByClassName('patient-details-close')[0];
        const patientSearchInput = document.getElementById('patient-search-input');
        const btnSaveFromList = document.getElementById('btn-save-from-list');
        
        const loginModal = document.getElementById('login-modal');
        const loginModalUser = document.getElementById('login-modal-user');
        const loginModalPass = document.getElementById('login-modal-pass');
        const loginModalButton = document.getElementById('login-modal-button');
        const loginModalFeedback = document.getElementById('login-modal-feedback');

        const savePatientModal = document.getElementById('save-patient-modal');
        const savePatientNameInput = document.getElementById('save-patient-name');
        const savePatientDobInput = document.getElementById('save-patient-dob');
        const savePatientButton = document.getElementById('save-patient-button');
        const savePatientFeedback = document.getElementById('save-patient-feedback');
        const savePatientModalClose = savePatientModal.querySelector('.app-modal-close');


        // Mobile text elements
        const statusTextApi = document.querySelector('.status-text-api');
        const statusTextMic = document.querySelector('.status-text-mic');
        const statusTextCam = document.querySelector('.status-text-cam');

        // Estado da aplicação
        let isListening = false;
        let isLoggedIn = false;
        let currentUser = null;
        let recognition = null;
        let audioStream = null; 
        let anamnesis = { qp: "", hma: "", hp: "", hf: "", hps: "" };
        let examsResults = "";
        let axonEyeResults = "";
        let lastAnamnesisInfo = "";
        let apiConnectionStatus = "Desconhecido";
        let unsubscribeSnapshot = null;
        let unsubscribeUserAuthListener = null;
        let cameraStream = null;
        let capturedImages = [];
        let temporaryImgurUploads = []; // Para armazenar uploads do /see antes de salvar
        let currentCameraFacingMode = 'environment';
        let currentMonitorView = 'anamnesis';
        let isFlashlightOn = false;
        let cameraMode = 'exams';
        const isMobileDevice = () => /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isMobile = isMobileDevice();
        let allPatients = [];

        let conversationHistory = [];

        // Configurações da API Gemini e Imgur
        const apiKeys = [
            'AIzaSyB7krrv-Jjw4hn34MIFYBcrzDa5mWB9PpU',
            'AIzaSyAJk2u0SsCv11d9mrECAkoBRafHEVGgwwg',
            'AIzaSyAG0j6JuMlR5FoCTUcNQOvNy_lcS5C9ew0'
        ];
        let currentApiKeyIndex = 1; // Start with the original default key index
        let currentGeminiAPIKey = apiKeys[currentApiKeyIndex];
        const IMGUR_CLIENT_ID = '546c25a59c58ad7'; 

        const apiModels = [
            { id: 1, name: 'gemini-robotics-er-1.5-preview', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-robotics-er-1.5-preview:generateContent?key=${key}`, vision: false },
            { id: 2, name: 'learnlm-2.0-flash-experimental', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/learnlm-2.0-flash-experimental:generateContent?key=${key}`, vision: true },
            { id: 3, name: 'gemini-2.0-flash-lite', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${key}`, vision: false },
            { id: 4, name: 'gemini-2.0-flash', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, vision: false },
            { id: 5, name: 'gemini-2.5-flash-lite', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${key}`, vision: true },
            { id: 6, name: 'gemini-2.5-flash', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, vision: true },
            { id: 7, name: 'gemini-flash-lite-latest', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-lite-latest:generateContent?key=${key}`, vision: true },
            { id: 8, name: 'gemini-flash-latest', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${key}`, vision: true },
            { id: 9, name: 'gemini-2.5-pro', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${key}`, vision: true },
            { id: 10, name: 'gemini-2.5-flash-image', urlBuilder: (key) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${key}`, vision: true }
        ];
        let currentAIModel = 'gemini-2.0-flash';
        let currentVisionAIModel = 'gemini-2.5-flash-lite';

        const getGeminiAPIUrl = (isVision = false) => {
            const modelName = isVision ? currentVisionAIModel : currentAIModel;
            const model = apiModels.find(m => m.name === modelName);
            if (model) {
                return model.urlBuilder(currentGeminiAPIKey);
            }
            const fallbackModel = isVision ? apiModels.find(m => m.vision) : apiModels.find(m => !m.vision);
            return fallbackModel.urlBuilder(currentGeminiAPIKey);
        };

        const validCommands = [
            '/exit', '/hear on', '/hear off', '/hd', '/cd', '/copy', 
            '/ia', '/help', '/clear', '/api', '/api-set', '/api-restore', '/api-engine', '/register', '/exames', '/see', '/ask', '/delete', '/pdf', '/load'
        ];

        const isSpeechRecognitionSupported = () => 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;

        const initSpeechRecognition = () => {
            if (!isSpeechRecognitionSupported()) {
                appendOutput("Reconhecimento de voz não suportado neste navegador.", "error");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'pt-BR';

            recognition.onstart = () => {
                isListening = true;
                micStatus.classList.remove('status-off');
                btnMic.classList.add('active');
                btnMic.innerHTML = '<i class="fas fa-microphone"></i>';
                appendOutput("Microfone ativado. Gravando consulta...", "success");
                if (isLoggedIn && currentUser) {
                    updateMonitorStateInFirestore(currentUser, { activeView: 'anamnesis' });
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                
                if (transcript.trim()) {
                    appendOutput(`[Voz] ${transcript}`, "info");
                    processAnamnesisInfo(transcript);
                }
            };

            recognition.onerror = (event) => {
                appendOutput(`Erro no reconhecimento de voz: ${event.error}`, "error");
                stopListening();
            };

            recognition.onend = () => {
                if (isListening) {
                    recognition.start();
                }
            };
        };

        const toggleListening = () => {
            if (!isListening) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        audioStream = stream;
                        recognition.start();
                    })
                    .catch(err => {
                        appendOutput(`Permissão de microfone negada: ${err.message}`, "error");
                    });
            } else {
                stopListening();
            }
        };

        const stopListening = () => {
            if (recognition) {
                recognition.stop();
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            isListening = false;
            micStatus.classList.add('status-off');
            btnMic.classList.remove('active');
            btnMic.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            appendOutput("Microfone desativado.", "info");
        };

        const appendOutput = (text, type = "output", logToFirebase = true) => {
            const outputElement = document.createElement('div');
            
            if (type === "command") {
                outputElement.innerHTML = `<span class="prompt">></span> <span class="command">${text}</span>`;
            } else if (type === "error") {
                outputElement.innerHTML = `<span class="error">${text}</span>`;
            } else if (type === "success") {
                outputElement.innerHTML = `<span class="success">${text}</span>`;
            } else if (type === "info") {
                outputElement.innerHTML = `<span class="info">${text}</span>`;
            } else if (type === "receituario") {
                outputElement.classList.add('receituario-item');
                outputElement.textContent = text;
            }
            else {
                outputElement.innerHTML = `<span class="${type}">${text}</span>`;
            }
            
            interactiveOutput.appendChild(outputElement);
            interactiveOutput.scrollTop = interactiveOutput.scrollHeight;

            if (logToFirebase && isLoggedIn && currentUser) {
                logInteractionToFirebase(currentUser, text, type, 'interactive');
            }
        };

        const resetInteractiveTerminal = (requireLogin = false) => {
            const elementsToKeep = [initialMessagesContainer];
            Array.from(interactiveOutput.children).forEach(child => {
                if (!elementsToKeep.includes(child) && !child.classList.contains('terminal-logo-internal')) {
                    child.remove();
                }
            });

            initialMessagesContainer.style.display = 'block';
            
            if (requireLogin) {
                isLoggedIn = false;
                currentUser = null;
                localStorage.removeItem('axon_logged_in_user');
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }
                if (unsubscribeUserAuthListener) {
                    unsubscribeUserAuthListener();
                    unsubscribeUserAuthListener = null;
                }
                initialMessagesContainer.innerHTML = `
                    <pre class="info">
 █████╗ ██╗  ██╗ ██████╗ ███╗   ██╗
██╔══██╗╚██╗██╔╝██╔═══██╗████╗  ██║
███████║ ╚███╔╝ ██║   ██║██╔██╗ ██║
██╔══██║ ██╔██╗ ██║   ██║██║╚██╗██║
██║  ██║██╔╝ ██╗╚██████╔╝██║ ╚████║
╚═╝  ╚═╝╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝
                    </pre>
                    <span class="info">Axon - Assistente Médico v1.0</span><br>
                    <span class="info">Aguardando autenticação...</span><br><br>
                `;
                loginModal.style.display = 'flex';
                loginModalUser.focus();
            } else {
                initialMessagesContainer.innerHTML = `
                    <pre class="info">
 █████╗ ██╗  ██╗ ██████╗ ███╗   ██╗
██╔══██╗╚██╗██╔╝██╔═══██╗████╗  ██║
███████║ ╚███╔╝ ██║   ██║██╔██╗ ██║
██╔══██║ ██╔██╗ ██║   ██║██║╚██╗██║
██║  ██║██╔╝ ██╗╚██████╔╝██║ ╚████║
╚═╝  ╚═╝╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝
                    </pre>
                    <span class="info">Axon - Assistente Médico v1.0</span><br>
                    <span class="info">Digite </span><span class="command">/help</span><span class="info"> para ver os comandos disponíveis</span><br>
                `;
            }
            interactiveOutput.scrollTop = interactiveOutput.scrollHeight;
        };

        const updateAnamnesisPreview = (logToFirebase = true) => {
            let previewHTML = `
                <div class="anamnesis-content">
                    <div class="section-title">Queixa Principal (QP):</div>
                    <div>${anamnesis.qp || "Ainda não informado."}</div><br>
                    <div class="section-title">História da Moléstia Atual (HMA):</div>
                    <div>${anamnesis.hma || "Ainda não informado."}</div><br>
                    <div class="section-title">História Patológica (HP):</div>
                    <div>${anamnesis.hp || "Ainda não informado."}</div><br>
                    <div class="section-title">História Familiar (HF):</div>
                    <div>${anamnesis.hf || "Ainda não informado."}</div><br>
                    <div class="section-title">História Psicossocial (HPS):</div>
                    <div>${anamnesis.hps || "Ainda não informado."}</div>
                </div>`;
            anamnesisPreview.innerHTML = previewHTML;
            if (logToFirebase && isLoggedIn && currentUser) {
                saveAnamnesisToFirestore(currentUser, anamnesis);
            }
        };

        const updateExamsResultsPreview = (logToFirebase = true) => {
            let formattedResults = '';
            if (examsResults) {
                formattedResults = examsResults.split('\n')
                    .filter(line => line.trim() !== '')
                    .map(line => {
                        if (line.includes('(Alterado)') || line.includes('(Anormal)')) {
                            const cleanLine = line.replace(/\(Alterado\)/g, '').replace(/\(Anormal\)/g, '').trim();
                            return `<div class="output">${cleanLine} <span class="altered-text">(Alterado)</span></div>`;
                        }
                        return `<div class="output">${line.trim()}</div>`;
                    }).join('');
            }
            examsResultsPreview.innerHTML = `<div class="section-title">RESULTADOS DOS EXAMES:</div>${formattedResults || '<div class="info">Nenhum exame analisado ainda.</div>'}`;
            if (logToFirebase && isLoggedIn && currentUser) {
                saveExamsResultsToFirestore(currentUser, examsResults);
            }
        };

        const updateAxonEyeResultsPreview = (logToFirebase = true) => {
            let formattedResults = '';
            let imageHtml = '';
            // A imagem mostrada aqui é a temporária, antes de salvar
            if (temporaryImgurUploads.length > 0 && currentMonitorView === 'axon-eye') {
                imageHtml = `<img src="${temporaryImgurUploads[0].link}" class="axon-eye-image-preview" alt="Imagem Analisada">`;
            }
            if (axonEyeResults) {
                const impressionRegex = /(Impressão Diagnóstica|Interpretação Clínica|Diagnósticos Diferenciais):\s*(.*)/i;
                let match = axonEyeResults.match(impressionRegex);
                if (match) {
                    const title = match[1];
                    const content = match[2].trim();
                    const preText = axonEyeResults.substring(0, match.index).trim();
                    const postText = axonEyeResults.substring(match.index + match[0].length).trim();
                    formattedResults += `<div class="output">${preText.split('\n').map(line => line.trim()).filter(line => line).join('<br>')}</div>`;
                    formattedResults += `<div class="axon-eye-title">${title}</div>`;
                    formattedResults += `<div class="output">${content}</div>`;
                    formattedResults += `<div class="output">${postText.split('\n').map(line => line.trim()).filter(line => line).join('<br>')}</div>`;
                } else {
                    formattedResults = axonEyeResults.split('\n').filter(line => line.trim() !== '').map(line => `<div class="output">${line.trim()}</div>`).join('');
                }
            }
            axonEyeResultsPreview.innerHTML = `<div class="section-title">ANÁLISE AXON EYE:</div>${formattedResults || '<div class="info">Nenhuma análise visual feita ainda.</div>'}${imageHtml}`;
            if (logToFirebase && isLoggedIn && currentUser) {
                saveAxonEyeResultsToFirestore(currentUser, axonEyeResults);
            }
        };

        const toggleMonitorView = (view, fromRemote = false) => {
            currentMonitorView = view;
            anamnesisPreview.style.display = 'none';
            examsResultsPreview.style.display = 'none';
            axonEyeResultsPreview.style.display = 'none';
            if (view === 'camera' && !fromRemote) {
                cameraModal.style.display = 'flex';
            } else {
                cameraModal.style.display = 'none';
                stopCameraStreamOnly();
            }
            toggleAnamnesisButton.classList.remove('active');
            toggleExamsButton.classList.remove('active');
            toggleAxonEyeButton.classList.remove('active');
            if (view === 'anamnesis') {
                anamnesisPreview.style.display = 'block';
                toggleAnamnesisButton.classList.add('active');
            } else if (view === 'exams') {
                examsResultsPreview.style.display = 'block';
                toggleExamsButton.classList.add('active');
            } else if (view === 'axon-eye') {
                axonEyeResultsPreview.style.display = 'block';
                toggleAxonEyeButton.classList.add('active');
            }
            if (!fromRemote && isLoggedIn && currentUser) {
                updateMonitorStateInFirestore(currentUser, { activeView: view });
            }
        };

        const callGeminiAPI = async (prompt) => {
            const textModelsToTry = [currentAIModel, 'gemini-2.5-flash', 'gemini-2.5-pro'];
            let lastError = null;

            for (const modelName of textModelsToTry) {
                const model = apiModels.find(m => m.name === modelName);
                if (!model) {
                    lastError = new Error(`Modelo ${modelName} não encontrado.`);
                    continue;
                }

                for (let i = 0; i < apiKeys.length; i++) {
                    const keyIndex = (currentApiKeyIndex + i) % apiKeys.length;
                    const apiKeyToTry = apiKeys[keyIndex];
                    
                    appendOutput(`Tentando motor ${modelName} com chave API #${keyIndex + 1}...`, "info", false);

                    try {
                        const response = await fetch(model.urlBuilder(apiKeyToTry), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            currentApiKeyIndex = keyIndex;
                            currentGeminiAPIKey = apiKeys[currentApiKeyIndex];
                            appendOutput(`Sucesso com motor ${modelName} e chave API #${keyIndex + 1}.`, "success", false);
                            return data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/\*\*/g, '') || "Não foi possível obter uma resposta.";
                        }

                        const errorData = await response.json().catch(() => ({ error: { message: `HTTP error! status: ${response.status}` } }));
                        lastError = new Error(errorData.error?.message || `Erro desconhecido (${response.status})`);
                        appendOutput(`Falha com chave API #${keyIndex + 1}: ${lastError.message}`, "error", false);

                    } catch (error) {
                        lastError = error;
                        appendOutput(`Falha de rede com chave API #${keyIndex + 1}: ${error.message}`, "error", false);
                    }
                }
                appendOutput(`Todas as chaves falharam para o motor ${modelName}. Tentando próximo motor...`, "error", false);
            }

            console.error("Erro final na chamada da API de texto:", lastError);
            throw lastError || new Error("Todas as tentativas de chaves e motores de texto falharam.");
        };

        const callGeminiVisionAPI = async (imageUrls, prompt) => {
            const visionModelsToTry = [currentVisionAIModel, 'gemini-2.5-flash', 'gemini-flash-latest'];
            let lastError = null;
        
            for (const modelName of visionModelsToTry) {
                const model = apiModels.find(m => m.name === modelName && m.vision);
                if (!model) {
                    lastError = new Error(`Modelo de visão ${modelName} não encontrado.`);
                    continue;
                }
                
                const imageParts = imageUrls.map(url => ({ inlineData: { mimeType: 'image/jpeg', data: url.split(',')[1] } }));
                const textPart = { text: prompt };

                for (let i = 0; i < apiKeys.length; i++) {
                    const keyIndex = (currentApiKeyIndex + i) % apiKeys.length;
                    const apiKeyToTry = apiKeys[keyIndex];
                    
                    appendOutput(`Tentando motor de visão ${modelName} com chave API #${keyIndex + 1}...`, "info", false);

                    try {
                        const response = await fetch(model.urlBuilder(apiKeyToTry), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [...imageParts, textPart] }] })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            currentApiKeyIndex = keyIndex;
                            currentGeminiAPIKey = apiKeys[currentApiKeyIndex];
                            appendOutput(`Sucesso com motor de visão ${modelName} e chave API #${keyIndex + 1}.`, "success", false);
                            return data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/\*\*/g, '') || "Não foi possível obter uma resposta da análise de imagem.";
                        }

                        const errorData = await response.json().catch(() => ({ error: { message: `HTTP error! status: ${response.status}` } }));
                        lastError = new Error(errorData.error?.message || `Erro desconhecido na API de Visão (${response.status})`);
                        appendOutput(`Falha com chave API #${keyIndex + 1}: ${lastError.message}`, "error", false);

                    } catch (error) {
                        lastError = error;
                        appendOutput(`Falha de rede com chave API #${keyIndex + 1}: ${error.message}`, "error", false);
                    }
                }
                appendOutput(`Todas as chaves falharam para o motor de visão ${modelName}. Tentando próximo motor...`, "error", false);
            }
            
            console.error("Erro final na chamada da API de visão:", lastError);
            throw lastError || new Error("Todas as tentativas de chaves e motores de visão falharam.");
        };


        const processAnamnesisInfo = async (info) => {
            lastAnamnesisInfo = info;
            const prompt = `Você é um assistente médico especialista em semiologia. Sua tarefa é redigir uma anamnese médica profissional, organizando as informações fornecidas em seções adequadas. A anamnese deve ser bem redigida, coesa e utilizar termos médicos apropriados.
            Contexto da consulta atual (informações existentes):
            - QP (Queixa Principal): "${anamnesis.qp || "Nenhuma"}"
            - HMA (História da Moléstia Atual): "${anamnesis.hma || "Nenhuma"}"
            - HP (História Patológica): "${anamnesis.hp || "Nenhuma"}"
            - HF (História Familiar): "${anamnesis.hf || "Nenhuma"}"
            - HPS (História Psicossocial): "${anamnesis.hps || "Nenhuma"}"

            Nova informação recebida (diálogo médico-paciente): "${info}"

            Instruções cruciais:
            1.  **Analise o contexto completo**: Considere tanto as informações existentes quanto a "nova informação recebida" para construir a anamnese mais precisa.
            2.  **Ordene logicamente**: Mesmo que as informações sejam fornecidas fora de ordem, organize-as de forma coerente dentro da seção correta (QP, HMA, HP, HF, HPS).
            3.  **Seja Fiel ao Conteúdo**: NÃO adicione, invente ou presuma informações que não foram explicitamente ditas. Frases como "Paciente não relata outros sintomas" ou "Paciente não sabe especificar" só devem ser incluídas se o médico ou paciente as tiverem mencionado.
            4.  **Distinga os interlocutores e filtre as perguntas**: Sua tarefa é extrair APENAS as respostas e relatos do paciente. IGNORE completamente as perguntas diretas feitas pelo médico. Por exemplo, se o diálogo for "Médico: Você tem febre? Paciente: Sim, desde ontem.", a informação a ser registrada é "Paciente relata febre desde o dia anterior". A pergunta "Você tem febre?" NÃO DEVE ser incluída no texto da anamnese.
            5.  **Atualize, não substitua**: Integre a nova informação à seção apropriada, complementando o que já existe. Mantenha o conteúdo das outras seções inalterado.
            6.  **Filtro Rigoroso de Relevância Clínica**: Ignore A-B-S-O-L-U-T-A-M-E-N-T-E qualquer parte da conversa que não seja estritamente sobre a saúde do paciente. Isso inclui, mas não se limita a: saudações (bom dia, olá), cumprimentos, despedidas, comentários sobre o tempo, trânsito, amenidades sociais ou qualquer diálogo que não descreva um sintoma, um histórico médico, um hábito de vida relevante (fumo, álcool) ou uma queixa. Seu foco é 100% clínico.

            Formato da Resposta: Retorne EXCLUSIVAMENTE um objeto JSON, contendo TODAS as chaves (qp, hma, hp, hf, hps) com os textos atualizados.`;
            try {
                const response = await callGeminiAPI(prompt);
                const jsonStart = response.indexOf('{');
                const jsonEnd = response.lastIndexOf('}') + 1;
                const jsonString = response.substring(jsonStart, jsonEnd);
                const updatedAnamnesis = JSON.parse(jsonString);
                anamnesis = {
                    qp: updatedAnamnesis.qp || "", hma: updatedAnamnesis.hma || "",
                    hp: updatedAnamnesis.hp || "", hf: updatedAnamnesis.hf || "",
                    hps: updatedAnamnesis.hps || ""
                };
                updateAnamnesisPreview();
                appendOutput("Anamnese atualizada com sucesso.", "success");
            } catch (error) {
                appendOutput(`Erro ao atualizar a anamnese: ${error.message}.`, "error");
            }
        };

        const generateDiagnosticHypotheses = async () => {
            const prompt = `Com base na anamnese: ${JSON.stringify(anamnesis)}, nos exames: ${examsResults || "Nenhum"}, e na análise visual: ${axonEyeResults || "Nenhuma"}, liste as hipóteses diagnósticas em ordem de probabilidade. Seja técnico e resumido. Retorne apenas a lista.`;
            try {
                const response = await callGeminiAPI(prompt);
                const formattedDiagnosis = response.split('\n').filter(item => item.trim()).map(item => `<div class="diagnosis-item">${item.trim()}</div>`).join('');
                appendOutput(`<div class="conduct-title">HIPÓTESES DIAGNÓSTICAS:</div>${formattedDiagnosis}`, "output");
            } catch (error) {
                appendOutput(`Erro ao gerar hipóteses: ${error.message}`, "error");
            }
        };

        const generateMedicalConduct = async () => {
            const prompt = `Com base na anamnese: ${JSON.stringify(anamnesis)}, exames: ${examsResults || "Nenhum"}, e análise visual: ${axonEyeResults || "Nenhuma"}, proponha uma conduta médica completa, dividida em: 1. Medicações (SUS), 2. Exames complementares (SUS), 3. Condutas não farmacológicas, 4. Recomendações. Seja técnico e resumido.`;
            try {
                const response = await callGeminiAPI(prompt);
                const formattedConduct = response
                    .replace(/Medicações:|Medicamentos:/gi, '<div class="conduct-title">MEDICAÇÕES (SUS):</div>')
                    .replace(/Exames complementares|Exames:/gi, '<div class="conduct-title">EXAMES COMPLEMENTAREs (SUS):</div>')
                    .replace(/Condutas não farmacológicas|Condutas não-farmacológicas:/gi, '<div class="conduct-title">CONDUTAS NÃO FARMACOLÓGICAS:</div>')
                    .replace(/Recomendações ao paciente|Recomendações:/gi, '<div class="conduct-title">RECOMENDAÇÕES:</div>')
                    .split('\n').map(line => {
                        if (line.trim() === '' || line.includes('<div')) return line;
                        return `<div class="conduct-item">${line.trim()}</div>`;
                    }).join('');
                appendOutput(formattedConduct, "output");
            } catch (error) {
                appendOutput(`Erro ao gerar conduta: ${error.message}`, "error");
            }
        };

        const askQuestionBasedOnContext = async (question) => {
            conversationHistory.push({ role: 'user', content: question });
            const prompt = `Você é um assistente médico falando com um médico qualificado. Contexto: ANAMNESE: ${JSON.stringify(anamnesis)}, EXAMES: ${examsResults || "Nenhum"}, ANÁLISE VISUAL: ${axonEyeResults || "Nenhum"}. HISTÓRICO DA CONVERSA: ${conversationHistory.map(e => `${e.role}: ${e.content}`).join('\n')}. PERGUNTA ATUAL: "${question}". Responda de forma técnica, detalhada e objetiva, obedecendo fielmente ao pedido do médico.`;
            try {
                const response = await callGeminiAPI(prompt);
                conversationHistory.push({ role: 'assistant', content: response });
                appendOutput(`Pergunta: ${question}\nResposta: ${response}`, "output");
            } catch (error) {
                appendOutput(`Erro ao processar pergunta: ${error.message}`, "error");
            }
        };
        
        const copyMonitorContent = () => {
            let contentToCopy = "";
            if (currentMonitorView === 'anamnesis') contentToCopy = anamnesisPreview.innerText;
            else if (currentMonitorView === 'exams') contentToCopy = examsResultsPreview.innerText.replace("RESULTADOS DOS EXAMES:", "").trim();
            else if (currentMonitorView === 'axon-eye') contentToCopy = axonEyeResultsPreview.innerText.replace("ANÁLISE AXON EYE:", "").trim();
            navigator.clipboard.writeText(contentToCopy).then(() => appendOutput("Conteúdo copiado.", "success"), () => appendOutput("Erro ao copiar.", "error"));
        };

        const checkApiStatus = async (modelName = currentAIModel) => {
            const model = apiModels.find(m => m.name === modelName);
            if (!model) return false;
            let requestBody;
            if (model.vision) {
                const dummyImagePart = { inlineData: { mimeType: 'image/png', data: 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' } };
                requestBody = JSON.stringify({ contents: [{ parts: [dummyImagePart, { text: "ping" }] }] });
            } else {
                requestBody = JSON.stringify({ contents: [{ parts: [{ text: "ping" }] }] });
            }
            try {
                const response = await fetch(model.urlBuilder(currentGeminiAPIKey), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: requestBody,
                    signal: AbortSignal.timeout(5000)
                });
                if (response.ok) {
                    apiConnectionStatus = "Conectado"; apiStatus.classList.remove('status-off'); return true;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    apiConnectionStatus = errorData?.error?.message || `Erro (${response.status})`;
                    apiStatus.classList.add('status-off'); return false;
                }
            } catch (error) {
                apiConnectionStatus = `Offline (${error.name || 'Timeout'})`; apiStatus.classList.add('status-off'); return false;
            }
        };

        const initializeAIModel = async () => {
            appendOutput("Verificando status da API...", "info", false);
            let textModelOK = await checkApiStatus(currentAIModel);
            if (!textModelOK) {
                const initialError = apiConnectionStatus;
                appendOutput(`Motor de texto padrão (${currentAIModel}) falhou: ${initialError}. Tentando alternativo...`, "error", false);
                currentAIModel = 'gemini-2.5-pro';
                textModelOK = await checkApiStatus(currentAIModel);
            }
            if (textModelOK) appendOutput(`Motor de texto (${currentAIModel}) conectado.`, "success", false);
            else appendOutput(`Motor de texto alternativo (${currentAIModel}) também falhou.`, "error", false);


            let visionModelOK = await checkApiStatus(currentVisionAIModel);
            if (!visionModelOK) {
                const initialError = apiConnectionStatus;
                appendOutput(`Motor de visão padrão (${currentVisionAIModel}) falhou: ${initialError}. Tentando alternativo...`, "error", false);
                currentVisionAIModel = 'gemini-2.5-pro';
                visionModelOK = await checkApiStatus(currentVisionAIModel);
            }
            if(visionModelOK) appendOutput(`Motor de visão (${currentVisionAIModel}) conectado.`, "success", false);
            else appendOutput(`Motor de visão alternativo (${currentVisionAIModel}) também falhou.`, "error", false);
        };

        // Firebase Functions
        const logInteractionToFirebase = async (username, content, type, terminal) => { try { await addDoc(collection(db, "sessions", username, "interactions"), { content, type, terminal, timestamp: new Date() }); } catch (e) { console.error("Erro no log Firebase: ", e); } };
        const saveAnamnesisToFirestore = async (username, data) => { try { await setDoc(doc(db, "sessions", username), { anamnesis: data, lastUpdated: new Date() }, { merge: true }); } catch (e) { console.error("Erro ao salvar anamnese: ", e); } };
        const saveExamsResultsToFirestore = async (username, data) => { try { await setDoc(doc(db, "sessions", username), { examsResults: data, lastUpdated: new Date() }, { merge: true }); } catch (e) { console.error("Erro ao salvar exames: ", e); } };
        const saveAxonEyeResultsToFirestore = async (username, data) => { try { await setDoc(doc(db, "sessions", username), { axonEyeResults: data, lastUpdated: new Date() }, { merge: true }); } catch (e) { console.error("Erro ao salvar Axon Eye: ", e); } };
        const updateMonitorStateInFirestore = async (username, state) => { try { await setDoc(doc(db, "sessions", username), { monitorState: { ...state, lastUpdated: new Date() } }, { merge: true }); } catch (e) { console.error("Erro ao salvar estado do monitor: ", e); } };
        
        const setupFirebaseListener = (username) => {
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            const docRef = doc(db, "sessions", username);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.anamnesis && JSON.stringify(data.anamnesis) !== JSON.stringify(anamnesis)) { anamnesis = data.anamnesis; updateAnamnesisPreview(false); }
                    if (data.examsResults && data.examsResults !== examsResults) { examsResults = data.examsResults; updateExamsResultsPreview(false); }
                    if (data.axonEyeResults && data.axonEyeResults !== axonEyeResults) { axonEyeResults = data.axonEyeResults; updateAxonEyeResultsPreview(false); }
                    if (data.monitorState && data.monitorState.activeView !== currentMonitorView) toggleMonitorView(data.monitorState.activeView, true);
                } else {
                    anamnesis = { qp: "", hma: "", hp: "", hf: "", hps: "" }; examsResults = ""; axonEyeResults = "";
                    updateAnamnesisPreview(false); updateExamsResultsPreview(false); updateAxonEyeResultsPreview(false);
                }
            });
        };

        const setupUserAuthListener = (username) => {
            if (unsubscribeUserAuthListener) {
                unsubscribeUserAuthListener();
                unsubscribeUserAuthListener = null;
            }

            const userRef = doc(db, "users", username);
            unsubscribeUserAuthListener = onSnapshot(userRef, (docSnap) => {
                if (isLoggedIn && currentUser === username && !docSnap.exists()) {
                    console.log("User document deleted, initiating auto-logout.");
                    appendOutput("Sua conta foi removida. Você foi desconectado.", "error", false);
                    handleLogout();
                }
            });
        };

        const registerUser = async (adminPassword, username, password) => {
            if (adminPassword !== 'admin123') return appendOutput("Senha de administrador incorreta.", "error");
            if (!username || !password) return appendOutput("Uso: /register [senha_admin] [usuário] [senha]", "error");
            try {
                const userRef = doc(db, "users", username);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) appendOutput(`Usuário '${username}' já existe.`, "error");
                else { await setDoc(userRef, { password, createdAt: new Date() }); appendOutput(`Usuário '${username}' registrado com sucesso.`, "success"); }
            } catch (e) { appendOutput(`Erro ao registrar: ${e.message}`, "error"); }
        };

        const deleteUser = async (adminPassword, username) => {
            if (adminPassword !== 'admin123') return appendOutput("Senha de administrador incorreta.", "error");
            if (!username) return appendOutput("Uso: /delete [senha_admin] [usuário]", "error");
            try {
                const userRef = doc(db, "users", username);
                await deleteDoc(userRef);
                appendOutput(`Usuário '${username}' deletado com sucesso.`, "success");
            } catch (e) { 
                appendOutput(`Erro ao deletar usuário: ${e.message}`, "error"); 
            }
        };

        const authenticateUser = async (username, password) => {
            try {
                const userRef = doc(db, "users", username);
                const docSnap = await getDoc(userRef);
                return docSnap.exists() && docSnap.data().password === password;
            } catch (e) { 
                console.error("Authentication error:", e);
                return false; 
            }
        };

        // Imgur API Functions
        const uploadToImgur = async (base64Image) => {
            try {
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        Authorization: `Client-ID ${IMGUR_CLIENT_ID}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Image.split(',')[1],
                        type: 'base64',
                        title: 'Axon Eye Analysis',
                        description: `Image uploaded by Axon A.I for user ${currentUser}`
                    }),
                });
                const data = await response.json();
                if (data.success) {
                    return { link: data.data.link, deleteHash: data.data.deletehash };
                } else {
                    throw new Error(data.data.error || 'Imgur upload failed');
                }
            } catch (error) {
                console.error("Imgur upload error:", error);
                appendOutput(`Erro ao fazer upload da imagem para o Imgur: ${error.message}`, 'error');
                return null;
            }
        };

        const deleteFromImgur = async (deleteHash) => {
            if (!deleteHash) return;
            try {
                await fetch(`https://api.imgur.com/3/image/${deleteHash}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `Client-ID ${IMGUR_CLIENT_ID}`,
                    },
                });
            } catch (error) {
                console.error("Imgur delete error:", error);
            }
        };
        
        const clearTemporaryUploads = async () => {
            if (temporaryImgurUploads.length > 0) {
                appendOutput('Limpando imagens temporárias não salvas...', 'info');
                for (const upload of temporaryImgurUploads) {
                    await deleteFromImgur(upload.deleteHash);
                }
                temporaryImgurUploads = [];
            }
        };


        // Camera and Image Processing Functions
        const startCamera = async (mode) => {
            cameraMode = mode;
            cameraModalTitle.textContent = mode === 'exams' ? 'Câmera de Exames' : 'Axon Eye';
            sendExamsButton.style.display = mode === 'exams' ? 'block' : 'none';
            sendAxonEyeButton.style.display = mode === 'axon-eye' ? 'block' : 'none';
            try {
                if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: isMobile ? 'environment' : currentCameraFacingMode } });
                cameraVideo.srcObject = stream; cameraStream = stream; toggleMonitorView('camera');
                cameraStatus.classList.remove('status-off');
                appendOutput(`Câmera ativada para ${mode === 'exams' ? 'exames' : 'análise visual'}.`, "info");
                albumButton.style.display = 'flex'; updateAlbumCount();
                const devices = await navigator.mediaDevices.enumerateDevices();
                if (devices.filter(d => d.kind === 'videoinput').length > 1) cameraSwitchButton.style.display = 'block';
                const track = stream.getVideoTracks()[0];
                if (track && 'torch' in track.getCapabilities()) flashlightButton.style.display = 'block';
            } catch (err) {
                appendOutput(`Erro ao acessar a câmera: ${err.message}.`, "error");
            }
        };
        const stopCameraStreamOnly = () => {
            if (cameraStream) {
                if (isFlashlightOn) toggleFlashlight();
                cameraStream.getTracks().forEach(track => track.stop()); cameraVideo.srcObject = null; cameraStream = null;
            }
            cameraStatus.classList.add('status-off');
        };
        const stopCamera = () => { stopCameraStreamOnly(); cameraModal.style.display = 'none'; toggleMonitorView(currentMonitorView === 'camera' ? 'anamnesis' : currentMonitorView); };
        const switchCamera = async () => { currentCameraFacingMode = (currentCameraFacingMode === 'user') ? 'environment' : 'user'; await startCamera(cameraMode); };
        const toggleFlashlight = async () => {
            if (!cameraStream) return;
            const track = cameraStream.getVideoTracks()[0];
            if (track && 'torch' in track.getCapabilities()) {
                try { await track.applyConstraints({ advanced: [{ torch: !isFlashlightOn }] }); isFlashlightOn = !isFlashlightOn; flashlightButton.classList.toggle('active', isFlashlightOn); } catch (err) { appendOutput("Erro ao controlar a lanterna.", "error"); }
            }
        };
        const capturePhoto = () => { if (!cameraStream) return; cameraCanvas.width = cameraVideo.videoWidth; cameraCanvas.height = cameraVideo.videoHeight; cameraCanvas.getContext('2d').drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height); addCapturedImage(cameraCanvas.toDataURL('image/jpeg')); };
        const handleFileUpload = (event) => { for (const file of event.target.files) { if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => addCapturedImage(e.target.result); reader.readAsDataURL(file); } } };
        const addCapturedImage = (imageDataURL) => { capturedImages.push(imageDataURL); updateAlbumCount(); sendExamsButton.classList.remove('disabled'); sendAxonEyeButton.classList.remove('disabled'); };
        const removeCapturedImage = (imageDataURL) => { capturedImages = capturedImages.filter(url => url !== imageDataURL); updateAlbumCount(); if (capturedImages.length === 0) { sendExamsButton.classList.add('disabled'); sendAxonEyeButton.classList.add('disabled'); } renderAlbum(); };
        const updateAlbumCount = () => { albumCount.textContent = capturedImages.length; albumButton.style.display = capturedImages.length > 0 ? 'flex' : 'none'; };
        const openAlbumModal = () => { renderAlbum(); albumModal.style.display = 'flex'; };
        const closeAlbumModal = () => { albumModal.style.display = 'none'; };
        const renderAlbum = () => {
            albumGrid.innerHTML = capturedImages.length === 0 ? '<div class="info" style="grid-column: 1 / -1; text-align: center;">Nenhuma imagem no álbum.</div>' : '';
            capturedImages.forEach(url => {
                const item = document.createElement('div'); item.className = 'album-item';
                const img = document.createElement('img'); img.src = url; img.className = 'album-image'; img.onclick = () => openFullscreenModal(url);
                const delBtn = document.createElement('button'); delBtn.className = 'album-delete-button'; delBtn.innerHTML = '&times;'; delBtn.onclick = (e) => { e.stopPropagation(); removeCapturedImage(url); };
                item.append(img, delBtn); albumGrid.appendChild(item);
            });
        };
        
        // FIX: Make function globally available for onclick attributes
        window.openFullscreenModal = (imageDataURL) => { 
            modalImage.src = imageDataURL; 
            fullscreenModal.style.display = 'block'; 
        };
        
        modalClose.onclick = () => fullscreenModal.style.display = 'none';
        fullscreenModal.onclick = (e) => { if (e.target === fullscreenModal) fullscreenModal.style.display = 'none'; };

        const analyzeExams = async () => {
            if (capturedImages.length === 0) return appendOutput("Nenhuma imagem de exame para analisar.", "info");
            examsResults = ""; updateExamsResultsPreview();
            examsResultsPreview.innerHTML = '<div class="info">Analisando imagens...</div>'; toggleMonitorView('exams');
            try {
                const prompt = `Analise as imagens de exames. Retorne os resultados em tópicos. Se houver alteração, adicione "(Alterado)" ou "(Anormal)". Exemplo: Glicose: 90 mg/dL (Alterado) Hemoglobina Glicada: 7.2%. Retorne apenas a lista de resultados.`;
                const response = await callGeminiVisionAPI(capturedImages, prompt);
                examsResults = response; updateExamsResultsPreview();
                appendOutput("Análise de exames concluída.", "success");
            } catch (error) {
                appendOutput(`Erro ao analisar exames: ${error.message}`, "error");
            } finally {
                stopCamera(); capturedImages = []; updateAlbumCount();
            }
        };

        const analyzeAxonEye = async () => {
            if (capturedImages.length === 0) return appendOutput("Nenhuma imagem para análise visual.", "info");
            
            await clearTemporaryUploads(); // Limpa uploads antigos não salvos
            axonEyeResults = ""; updateAxonEyeResultsPreview();
            axonEyeResultsPreview.innerHTML = '<div class="info">Axon Eye está analisando e fazendo upload...</div>'; toggleMonitorView('axon-eye');

            try {
                // Upload para o Imgur primeiro
                for (const imgBase64 of capturedImages) {
                    const uploadResult = await uploadToImgur(imgBase64);
                    if (uploadResult) {
                        temporaryImgurUploads.push(uploadResult);
                    }
                }
                if (temporaryImgurUploads.length !== capturedImages.length) {
                    throw new Error("Falha no upload de uma ou mais imagens.");
                }

                const prompt = `Analise as imagens e forneça uma opinião clínica detalhada. Descreva achados, lesões, ou sintomas. Ao final, inclua uma seção "Impressão Diagnóstica:" ou "Interpretação Clínica:" com sua conclusão. Seja descritivo e clinicamente relevante.`;
                const response = await callGeminiVisionAPI(capturedImages, prompt);
                axonEyeResults = response; updateAxonEyeResultsPreview();
                appendOutput("Análise Axon Eye concluída. Imagens prontas para salvar.", "success");
            } catch (error) {
                appendOutput(`Erro com Axon Eye: ${error.message}`, "error");
                await clearTemporaryUploads(); // Limpa em caso de erro
            } finally {
                stopCamera(); capturedImages = []; updateAlbumCount();
            }
        };

        const savePatient = async (patientName, birthDate) => {
            if (!isLoggedIn) {
                appendOutput("Você precisa estar logado.", "error");
                return;
            }
            savePatientButton.disabled = true;
            savePatientFeedback.textContent = 'Salvando...';
        
            try {
                const patientId = `${currentUser}_${patientName.replace(/\s+/g, '_').toLowerCase()}_${birthDate.replace(/\//g, '')}`;
                const patientRef = doc(db, "patients", patientId);
        
                const newConsultation = {
                    date: new Date(),
                    anamnesis: { ...anamnesis },
                    examsResults,
                    axonEyeResults,
                    axonEyeImages: [...temporaryImgurUploads], // Salva os links do Imgur para esta consulta
                };
        
                const docSnap = await getDoc(patientRef);
        
                if (docSnap.exists()) {
                    const existingData = docSnap.data();
                    const updatedConsultations = existingData.consultations ? [...existingData.consultations, newConsultation] : [newConsultation];
                    await updateDoc(patientRef, {
                        consultations: updatedConsultations,
                        lastUpdated: new Date()
                    });
                    appendOutput(`Nova consulta salva para '${patientName}'.`, "success");
                } else {
                    await setDoc(patientRef, {
                        patientName,
                        birthDate,
                        savedBy: currentUser,
                        createdAt: new Date(),
                        consultations: [newConsultation],
                        lastUpdated: new Date()
                    });
                    appendOutput(`Paciente '${patientName}' e primeira consulta salvos com sucesso.`, "success");
                }
        
                temporaryImgurUploads = []; // Limpa os temporários APÓS salvar com sucesso
                closeSaveModal();
            } catch (e) {
                appendOutput(`Erro ao salvar paciente: ${e.message}`, "error");
                savePatientFeedback.textContent = `Erro: ${e.message}`;
            } finally {
                savePatientButton.disabled = false;
            }
        };

        const loadPatientList = async () => {
            if (!isLoggedIn) return appendOutput("Você precisa estar logado.", "error");
            try {
                const q = query(collection(db, "patients"), where("savedBy", "==", currentUser));
                const querySnapshot = await getDocs(q);
                
                allPatients = [];
                querySnapshot.forEach((doc) => {
                    allPatients.push({ id: doc.id, ...doc.data() });
                });

                allPatients.sort((a, b) => {
                    const dateA = a.lastUpdated?.toDate() || a.createdAt?.toDate() || 0;
                    const dateB = b.lastUpdated?.toDate() || b.createdAt?.toDate() || 0;
                    return dateB - dateA;
                });

                patientList.innerHTML = '';
                if (allPatients.length === 0) {
                    patientList.innerHTML = '<div class="info">Nenhum paciente salvo.</div>';
                } else {
                    allPatients.forEach(p => {
                        const hasConsultations = p.consultations && p.consultations.length > 0;
                        
                        let lastConsultDateStr = 'Nenhuma consulta registrada';
                        if (hasConsultations) {
                            const mostRecentConsult = p.consultations
                                .filter(c => c.date && c.date.toDate) 
                                .sort((a, b) => b.date.toDate() - a.date.toDate())[0];
                            if (mostRecentConsult) {
                                lastConsultDateStr = mostRecentConsult.date.toDate().toLocaleString();
                            }
                        }

                        const item = document.createElement('div'); 
                        item.className = 'patient-item';
                        item.dataset.patientId = p.id;
                        item.innerHTML = `<div><strong>${p.patientName}</strong> - ${p.birthDate || 'N/A'}</div>
                                          <div style="font-size: 12px; color: #888;">Última consulta: ${lastConsultDateStr}</div>
                                          <div class="patient-actions">
                                            <button class="patient-action-button delete" data-id="${p.id}"><i class="fas fa-trash"></i> Excluir</button>
                                            <button class="patient-action-button details ${!hasConsultations ? 'disabled' : ''}" data-id="${p.id}"><i class="fas fa-eye"></i> Detalhes</button>
                                            <button class="patient-action-button pdf ${!hasConsultations ? 'disabled' : ''}" data-id="${p.id}"><i class="fas fa-file-pdf"></i> PDF</button>
                                          </div>`;
                        patientList.appendChild(item);
                    });
                }
                patientListModal.style.display = 'flex';
            } catch (e) {
                appendOutput(`Erro ao carregar pacientes: ${e.message}`, "error");
                console.error("Erro em loadPatientList:", e);
            }
        };

        const deletePatient = async (patientId) => {
            if (!confirm("Tem certeza que deseja excluir este paciente e TODAS as suas consultas? A ação é irreversível.")) return;
            try {
                const patientRef = doc(db, "patients", patientId);
                const docSnap = await getDoc(patientRef);

                if (docSnap.exists()) {
                    const patientData = docSnap.data();
                    if (patientData.consultations && patientData.consultations.length > 0) {
                        appendOutput("Excluindo imagens associadas do Imgur...", "info");
                        for (const consult of patientData.consultations) {
                            if (consult.axonEyeImages && consult.axonEyeImages.length > 0) {
                                for (const img of consult.axonEyeImages) {
                                    await deleteFromImgur(img.deleteHash); 
                                }
                            }
                        }
                    }
                }

                await deleteDoc(patientRef);
                appendOutput("Paciente e todos os registros foram excluídos com sucesso.", "success");
                await loadPatientList();
            } catch (e) {
                appendOutput(`Erro ao excluir paciente: ${e.message}`, "error");
            }
        };

        const generatePatientPDF = async (patientId) => {
            try {
                const patientSnap = await getDoc(doc(db, "patients", patientId));
                if (!patientSnap.exists()) return appendOutput("Paciente não encontrado.", "error");
                
                const patient = patientSnap.data();
                if (!patient.consultations || patient.consultations.length === 0) {
                    return appendOutput("Nenhuma consulta registrada para gerar PDF.", "info");
                }

                const { jsPDF } = window.jspdf; 
                const pdfDoc = new jsPDF();
                
                pdfDoc.setFontSize(18).text('AXON A.I - Prontuário Médico Completo', 105, 20, { align: 'center' });
                pdfDoc.setFontSize(14).text(`Paciente: ${patient.patientName}`, 14, 35);
                pdfDoc.setFontSize(12).text(`Data de Nascimento: ${patient.birthDate || 'N/A'}`, 14, 42);
                pdfDoc.line(14, 45, 196, 45);

                let y = 55;
                const pageHeight = pdfDoc.internal.pageSize.height;
                const addSection = (title, content, doc) => {
                    if (!content || (typeof content === 'string' && !content.trim()) || (typeof content === 'object' && Object.values(content).every(v => !v))) return;
                    
                    if (y + 15 > pageHeight - 20) { doc.addPage(); y = 20; }
                    doc.setFontSize(12).setFont(undefined, 'bold').text(title, 14, y); y += 7;
                    
                    const text = typeof content === 'object' ? Object.entries(content).map(([k, v]) => `${k.toUpperCase()}: ${v || 'Não informado'}`).join('\n') : content;
                    const splitText = doc.splitTextToSize(text, 180);
                    
                    if (y + (splitText.length * 5) > pageHeight - 20) { doc.addPage(); y = 20; }
                    doc.setFontSize(10).setFont(undefined, 'normal').text(splitText, 14, y);
                    y += splitText.length * 5 + 5;
                };

                const sortedConsultations = [...patient.consultations]
                    .filter(c => c.date && c.date.toDate)
                    .sort((a, b) => (a.date.toDate()) - (b.date.toDate()));

                sortedConsultations.forEach((consult, index) => {
                    if (y + 20 > pageHeight - 20) { pdfDoc.addPage(); y = 20; }
                    
                    const consultDate = consult.date ? consult.date.toDate().toLocaleString() : 'Data indisponível';
                    pdfDoc.setFontSize(14).setFont(undefined, 'bold').text(`Consulta ${index + 1}: ${consultDate}`, 105, y, { align: 'center' });
                    y += 5;
                    pdfDoc.line(14, y, 196, y);
                    y += 10;
                    
                    addSection('Anamnese', consult.anamnesis, pdfDoc);
                    addSection('Resultados dos Exames', consult.examsResults, pdfDoc);
                    addSection('Análise Visual (Axon Eye)', consult.axonEyeResults, pdfDoc);
                });
                
                pdfDoc.save(`prontuario_${patient.patientName.replace(/\s+/g, '_')}.pdf`);
                appendOutput(`PDF do prontuário completo gerado com sucesso.`, "success");

            } catch (e) { appendOutput(`Erro ao gerar PDF: ${e.message}`, "error"); console.error(e); }
        };
        
        const generatePDFFromCurrentSession = (patientName) => {
            if (!patientName) {
                appendOutput("Uso: /pdf [nome_do_paciente]", "error");
                return;
            }
        
            const { jsPDF } = window.jspdf;
            const pdfDoc = new jsPDF();
        
            pdfDoc.setFontSize(18).text('AXON A.I - Prontuário Médico', 105, 20, { align: 'center' });
            pdfDoc.setFontSize(14).text(`Paciente: ${patientName}`, 14, 35);
            pdfDoc.setFontSize(12).text(`Gerado em: ${new Date().toLocaleString()}`, 14, 42);
            pdfDoc.line(14, 45, 196, 45);
        
            let y = 55;
            const pageHeight = pdfDoc.internal.pageSize.height;
        
            const addSection = (title, content) => {
                if (!content || (typeof content === 'string' && !content.trim()) || (typeof content === 'object' && Object.values(content).every(v => !v))) return;
        
                if (y + 15 > pageHeight - 20) { pdfDoc.addPage(); y = 20; }
                pdfDoc.setFontSize(12).setFont(undefined, 'bold').text(title, 14, y); y += 7;
        
                const text = typeof content === 'object' ? Object.entries(content).map(([k, v]) => `${k.toUpperCase()}: ${v || 'Não informado'}`).join('\n') : content;
                const splitText = pdfDoc.splitTextToSize(text, 180);
        
                if (y + (splitText.length * 5) > pageHeight - 20) { pdfDoc.addPage(); y = 20; }
                pdfDoc.setFontSize(10).setFont(undefined, 'normal').text(splitText, 14, y);
                y += splitText.length * 5 + 5;
            };
        
            addSection('Anamnese', anamnesis);
            addSection('Resultados dos Exames', examsResults);
            addSection('Análise Visual (Axon Eye)', axonEyeResults);
        
            pdfDoc.save(`prontuario_atual_${patientName.replace(/\s+/g, '_')}.pdf`);
            appendOutput(`PDF da sessão atual gerado com sucesso.`, "success");
        };


        const showPatientDetails = (patient) => {
            patientDetailsTitle.textContent = `Paciente: ${patient.patientName}`;
            let detailsHTML = '';
            
            const addDetailSection = (title, content) => {
                if (!content || (typeof content === 'string' && !content.trim()) || (typeof content === 'object' && Object.values(content).every(v => !v))) return '';
                let body = '';
                if (typeof content === 'object') body = Object.entries(content).map(([k, v]) => `<strong>${k.toUpperCase()}:</strong> ${v || "Não informado"}<br>`).join('');
                else body = content.replace(/\n/g, '<br>');
                return `<div class="patient-details-section"><div class="patient-details-section-title">${title}</div><div>${body}</div></div>`;
            };

            if (patient.consultations && patient.consultations.length > 0) {
                const sortedConsultations = [...patient.consultations]
                    .filter(c => c.date && c.date.toDate)
                    .sort((a, b) => b.date.toDate() - a.date.toDate());
                detailsHTML += `<div class="consultation-list">`;
                sortedConsultations.forEach((consult, index) => {
                    const consultDate = consult.date ? consult.date.toDate().toLocaleString() : 'Data indisponível';
                    detailsHTML += `<div class="consultation-item">
                                        <div class="consultation-header">
                                            <i class="fas fa-chevron-right"></i> Consulta de ${consultDate}
                                        </div>
                                        <div class="consultation-body" style="display: none;">
                                            ${addDetailSection('ANAMNESE', consult.anamnesis)}
                                            ${addDetailSection('RESULTADOS DOS EXAMES', consult.examsResults)}
                                            ${addDetailSection('ANÁLISE VISUAL (AXON EYE)', consult.axonEyeResults)}`;
                    if (consult.axonEyeImages && consult.axonEyeImages.length > 0) {
                        detailsHTML += `<div class="patient-details-section"><div class="patient-details-section-title">IMAGENS (${consult.axonEyeImages.length})</div><div class="patient-images-grid">`;
                        consult.axonEyeImages.forEach(img => {
                            detailsHTML += `<div class="patient-image-item"><img src="${img.link}" class="patient-image" onclick="openFullscreenModal('${img.link}')" alt="Imagem do paciente"></div>`;
                        });
                        detailsHTML += `</div></div>`;
                    }
                    detailsHTML += `</div></div>`;
                });
                detailsHTML += `</div>`;
            } else {
                 detailsHTML = '<div class="info">Nenhuma consulta registrada para este paciente.</div>';
            }
            patientDetailsBody.innerHTML = detailsHTML;
            patientDetailsModal.style.display = 'flex';
        };

        const openSaveModal = () => {
            savePatientNameInput.value = '';
            savePatientDobInput.value = '';
            savePatientFeedback.textContent = '';
            savePatientModal.style.display = 'flex';
            savePatientNameInput.focus();
        };

        const closeSaveModal = () => {
            savePatientModal.style.display = 'none';
        };

        const handleSuccessfulLogin = (username, isRestoredSession = false) => {
            isLoggedIn = true; 
            currentUser = username; 
            localStorage.setItem('axon_logged_in_user', username);
            
            loginModal.style.display = 'none';
            
            if (isRestoredSession) {
                appendOutput(`Sessão restaurada para: ${currentUser}`, "success", false);
            } else {
                appendOutput(`Login bem-sucedido. Bem-vindo, ${currentUser}.`, "success", false);
            }
            
            initialMessagesContainer.style.display = 'none';
            appendOutput("Sessão pronta. Informe os dados do paciente ou use um comando.", "success");
            
            setupFirebaseListener(currentUser);
            setupUserAuthListener(currentUser); 
            
            toggleMonitorView('anamnesis');
            initializeAIModel();
        };

        const handleLogout = async () => {
            if (!isLoggedIn) return;
            
            appendOutput("Fazendo logout e limpando a sessão...", "info", false);

            if (isListening) stopListening();
            if (cameraStream) stopCamera();

            await clearTemporaryUploads();

            if (currentUser) {
                try {
                    await deleteDoc(doc(db, "sessions", currentUser));
                } catch (e) {
                    console.error("Falha ao deletar a sessão ao sair:", e);
                }
            }

            anamnesis = { qp: "", hma: "", hp: "", hf: "", hps: "" };
            examsResults = "";
            axonEyeResults = "";
            capturedImages = [];
            conversationHistory = [];
            
            updateAnamnesisPreview(false);
            updateExamsResultsPreview(false);
            updateAxonEyeResultsPreview(false);
            updateAlbumCount();

            resetInteractiveTerminal(true);
        };

        const searchPatients = (searchTerm) => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const patientItems = patientList.querySelectorAll('.patient-item');
            let visibleCount = 0;

            patientItems.forEach(item => {
                const patientName = item.querySelector('strong')?.textContent.toLowerCase();
                if (patientName && patientName.includes(lowerCaseSearchTerm)) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            const noResultsMessage = patientList.querySelector('.info');
            if (noResultsMessage) {
                noResultsMessage.remove();
            }

            if (visibleCount === 0 && patientItems.length > 0) {
                const noResults = document.createElement('div');
                noResults.className = 'info';
                noResults.textContent = 'Nenhum paciente encontrado.';
                patientList.appendChild(noResults);
            }
        };

        const processCommand = async (command) => {
            if (!command.trim()) return;
            appendOutput(command, "command");
        
            const parts = command.trim().split(' ');
            const mainCmd = parts[0].toLowerCase();
            const isCommand = mainCmd.startsWith('/');
        
            if (!isLoggedIn) {
                appendOutput("Por favor, faça o login para continuar.", "error");
                commandInput.value = '';
                return;
            }
        
            if (!isCommand) {
                await processAnamnesisInfo(command);
                commandInput.value = '';
                return;
            }
        
            if (!validCommands.some(vc => mainCmd === vc.split(' ')[0])) {
                appendOutput(`Comando '${mainCmd}' não existe. Digite /help para ver os comandos disponíveis.`, "error");
                commandInput.value = '';
                return;
            }
        
            switch (mainCmd) {
                case '/exit':
                    handleLogout();
                    break;
        
                case '/clear':
                    await clearTemporaryUploads();
                    if (currentUser) await deleteDoc(doc(db, "sessions", currentUser));
                    anamnesis = { qp: "", hma: "", hp: "", hf: "", hps: "" };
                    examsResults = "";
                    axonEyeResults = "";
                    conversationHistory = [];
                    updateAnamnesisPreview(false);
                    updateExamsResultsPreview(false);
                    updateAxonEyeResultsPreview(false);
                    resetInteractiveTerminal(false);
                    appendOutput("Sessão limpa.", "success");
                    break;
        
                case '/hear':
                    if (parts[1] === 'on') toggleListening();
                    else if (parts[1] === 'off') stopListening();
                    else appendOutput("Uso: /hear on|off", "error");
                    break;
        
                case '/hd':
                    appendOutput("Gerando hipóteses diagnósticas...", "info");
                    await generateDiagnosticHypotheses();
                    break;
        
                case '/cd':
                    appendOutput("Gerando conduta médica...", "info");
                    await generateMedicalConduct();
                    break;
        
                case '/copy':
                    copyMonitorContent();
                    break;
        
                case '/ia':
                    const questionIA = command.substring(3).trim();
                    if (!questionIA) {
                        appendOutput("Uso: /ia [pergunta]", "error");
                        break;
                    }
                    appendOutput("Processando sua pergunta...", "info");
                    try {
                        const response = await callGeminiAPI(`Responda de forma objetiva à pergunta médica: "${questionIA}"`);
                        appendOutput(response, "output");
                    } catch (error) {
                        appendOutput(`Erro ao consultar a IA: ${error.message}`, "error");
                    }
                    break;
        
                case '/ask':
                    const questionAsk = command.substring(4).trim();
                    if (!questionAsk) {
                        appendOutput("Uso: /ask [pergunta contextual]", "error");
                        break;
                    }
                    appendOutput("Processando pergunta contextual...", "info");
                    await askQuestionBasedOnContext(questionAsk);
                    break;
        
                case '/api-set':
                    const [, adminPassSet, newKey] = parts;
                    if (adminPassSet === 'admin123' && newKey) {
                        currentGeminiAPIKey = newKey;
                        appendOutput(`Chave da API alterada. Verificando...`, "success");
                        await checkApiStatus();
                    } else {
                        appendOutput("Uso: /api-set [senha_admin] [nova_chave]", "error");
                    }
                    break;
        
                case '/api-restore':
                    if (parts[1] === 'admin123') {
                        currentGeminiAPIKey = apiKeys[1]; // Restore to the original default key
                        currentApiKeyIndex = 1;
                        appendOutput("Chave da API restaurada para o padrão. Verificando...", "success");
                        await checkApiStatus();
                    } else {
                        appendOutput("Senha de administrador incorreta.", "error");
                    }
                    break;
        
                case '/api-engine':
                    const [, adminPassEngine, engineId] = parts;
                    if (adminPassEngine === 'admin123' && engineId) {
                        const model = apiModels.find(m => m.id == engineId || m.name.toLowerCase() === engineId.toLowerCase());
                        if (model) {
                            if (model.vision) currentVisionAIModel = model.name;
                            else currentAIModel = model.name;
                            appendOutput(`Motor ${model.vision ? 'de visão' : 'de texto'} alterado para: ${model.name}. Verificando...`, "success");
                            await checkApiStatus(model.name);
                        } else {
                            appendOutput(`Motor '${engineId}' não encontrado.`, "error");
                        }
                    } else {
                        appendOutput("Uso: /api-engine [senha_admin] [id_do_motor]", "error");
                    }
                    break;
        
                case '/api':
                    const availableEngines = apiModels.map(m => `  ${m.id}. ${m.name} (${m.vision ? 'visão' : 'texto'})`).join('\n');
                    appendOutput(`Status da API: ${apiConnectionStatus}\nMotor de texto atual: ${currentAIModel}\nMotor de visão atual: ${currentVisionAIModel}\n\nMotores disponíveis:\n${availableEngines}`, "info");
                    break;
        
                case '/register':
                    const [, adminPassReg, newUser, newPass] = parts;
                    await registerUser(adminPassReg, newUser, newPass);
                    break;
        
                case '/delete':
                    const [, adminPassDel, userToDel] = parts;
                    await deleteUser(adminPassDel, userToDel);
                    break;
        
                case '/help':
                    appendOutput(`Comandos: ${validCommands.join(', ')}`, "info");
                    break;
        
                case '/exames':
                    await startCamera('exams');
                    break;
        
                case '/see':
                    await startCamera('axon-eye');
                    break;
        
                case '/load':
                    await loadPatientList();
                    break;
        
                case '/pdf':
                    const patientName = command.substring(4).trim();
                    generatePDFFromCurrentSession(patientName);
                    break;
        
                default:
                    appendOutput(`Comando '${mainCmd}' não reconhecido.`, "error");
            }
        
            commandInput.value = '';
        };

        // Event Listeners
        commandInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') processCommand(commandInput.value); });
        logoutBtn.addEventListener('click', handleLogout);
        monitorCopyBtn.addEventListener('click', copyMonitorContent);
        captureButton.addEventListener('click', capturePhoto);
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        sendExamsButton.addEventListener('click', analyzeExams);
        sendAxonEyeButton.addEventListener('click', analyzeAxonEye);
        cancelCameraButton.addEventListener('click', stopCamera);
        cameraSwitchButton.addEventListener('click', switchCamera);
        flashlightButton.addEventListener('click', toggleFlashlight);
        cameraCloseBtn.addEventListener('click', stopCamera);
        toggleAnamnesisButton.addEventListener('click', () => toggleMonitorView('anamnesis'));
        toggleExamsButton.addEventListener('click', () => toggleMonitorView('exams'));
        toggleAxonEyeButton.addEventListener('click', () => toggleMonitorView('axon-eye'));
        albumButton.addEventListener('click', openAlbumModal);
        albumModalClose.addEventListener('click', closeAlbumModal);
        albumModal.addEventListener('click', (e) => { if (e.target === albumModal) closeAlbumModal(); });

        // Action Buttons
        btnExames.addEventListener('click', () => processCommand('/exames'));
        btnSee.addEventListener('click', () => processCommand('/see'));
        btnHd.addEventListener('click', () => processCommand('/hd'));
        btnCd.addEventListener('click', () => processCommand('/cd'));
        btnRecords.addEventListener('click', () => processCommand('/load'));
        btnClear.addEventListener('click', () => processCommand('/clear'));
        btnMic.addEventListener('click', () => processCommand(isListening ? '/hear off' : '/hear on'));
        btnSaveFromList.addEventListener('click', () => {
            patientListModal.style.display = 'none';
            openSaveModal();
        });


        // Modais de Pacientes
        patientListModal.addEventListener('click', (e) => {
            const target = e.target;
            const deleteButton = target.closest('.delete');
            const pdfButton = target.closest('.pdf');
            const detailsButton = target.closest('.details');
            const patientItem = target.closest('.patient-item');

            if (deleteButton) {
                deletePatient(deleteButton.dataset.id);
            } else if (pdfButton && !pdfButton.classList.contains('disabled')) {
                generatePatientPDF(pdfButton.dataset.id);
            } else if (detailsButton && !detailsButton.classList.contains('disabled')) {
                const patientId = detailsButton.dataset.id;
                const patientData = allPatients.find(p => p.id === patientId);
                if (patientData) showPatientDetails(patientData);
            } else if (patientItem) {
                const detailsBtnInItem = patientItem.querySelector('.details');
                if (detailsBtnInItem && !detailsBtnInItem.classList.contains('disabled')) {
                    const patientId = patientItem.dataset.patientId;
                    const patientData = allPatients.find(p => p.id === patientId);
                    if (patientData) showPatientDetails(patientData);
                }
            }
        });

        patientDetailsModal.addEventListener('click', (e) => {
            const header = e.target.closest('.consultation-header');
            if (header) {
                const body = header.nextElementSibling;
                const icon = header.querySelector('i');
                const isVisible = body.style.display === 'block';
                body.style.display = isVisible ? 'none' : 'block';
                icon.classList.toggle('fa-chevron-down', !isVisible);
                icon.classList.toggle('fa-chevron-right', isVisible);
            }
        });
        
        patientListClose.addEventListener('click', () => patientListModal.style.display = 'none');
        patientDetailsClose.addEventListener('click', () => patientDetailsModal.style.display = 'none');
        patientSearchInput.addEventListener('input', (e) => searchPatients(e.target.value));

        // Modal de Login
        loginModalButton.addEventListener('click', async () => {
            loginModalButton.disabled = true;
            loginModalFeedback.textContent = "Verificando...";
            const username = loginModalUser.value.trim();
            const password = loginModalPass.value.trim();
            
            if (!username || !password) {
                loginModalFeedback.textContent = "Preencha todos os campos.";
                loginModalButton.disabled = false;
                return;
            }

            if (await authenticateUser(username, password)) {
                loginModalFeedback.style.color = 'var(--success-color)'; 
                loginModalFeedback.textContent = "Sucesso!";
                setTimeout(() => {
                    handleSuccessfulLogin(username, false);
                    loginModalButton.disabled = false;
                    loginModalFeedback.textContent = "";
                }, 500);
            } else {
                loginModalFeedback.style.color = 'var(--error-color)'; 
                loginModalFeedback.textContent = "Usuário ou senha incorretos.";
                loginModalButton.disabled = false;
            }
        });
        loginModalPass.addEventListener('keydown', (e) => { if (e.key === 'Enter') loginModalButton.click(); });
        
        // Modal de Salvar
        savePatientModalClose.addEventListener('click', closeSaveModal);
        savePatientButton.addEventListener('click', () => {
            const name = savePatientNameInput.value.trim();
            const dob = savePatientDobInput.value.trim();
            if (!name || !dob) return savePatientFeedback.textContent = 'Preencha todos os campos.';
            savePatient(name, dob);
        });
        savePatientDobInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length > 5) {
                value = value.substring(0, 5) + '/' + value.substring(5);
            }
            e.target.value = value.substring(0, 10);
        });
        savePatientDobInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') savePatientButton.click(); });


        const initApp = async () => {
            if (isSpeechRecognitionSupported()) initSpeechRecognition();
            const savedUser = localStorage.getItem('axon_logged_in_user');
            if (savedUser) {
                const userExists = await authenticateUser(savedUser, null); 
                const userRef = doc(db, "users", savedUser);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    handleSuccessfulLogin(savedUser, true);
                } else {
                    localStorage.removeItem('axon_logged_in_user');
                    loginModal.style.display = 'flex';
                    loginModalUser.focus();
                }
            } else { 
                loginModal.style.display = 'flex'; 
                loginModalUser.focus(); 
            }
            if (isMobile) { 
                document.querySelectorAll('.status-text-api, .status-text-mic, .status-text-cam').forEach(el => el.style.display = 'none');
            }
        };

        document.addEventListener('DOMContentLoaded', initApp);
        
    </script>
</body>
</html>
